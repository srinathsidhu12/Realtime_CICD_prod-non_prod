pipeline {
    agent any
    parameters {
        string(
            name: 'IMAGE_TAG',
            description: 'Enter finalized Docker image tag (already validated in non-prod)'
        )
    }

    environment {
        DOCKER_IMAGE = "srinathsidhu12/java_spring_boot_sample_app"
        K8S_DEPLOYMENT_NAME = "springboot-demo"
    }

    stages {

        stage('Checkout Prod Manifests') {
            steps {
                git 'https://github.com/srinathsidhu12/Realtime_CICD_prod-non_prod.git'	
            }
        }

        stage('Validate Docker Image Tag') {
            steps {
                 withCredentials([usernamePassword(
                    credentialsId: 'dockerhub-id',
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]){
                 sh """
                   echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                   docker pull ${DOCKER_IMAGE}:${IMAGE_TAG}
                 """
                }
            }
         }
        stage('Manual Approval') {
            agent none
            steps {
                input message: "Approve deployment of image ${IMAGE_TAG} to PRODUCTION?"
            }
        }

        stage('Update Kubernetes Manifest and Deploy to Production Cluster') {
            steps {
              withCredentials([file(credentialsId: 'kubeconfig_prod', variable: 'KUBECONFIG')]) {
                sh """
                  sed -i 's|image:.*|image: ${DOCKER_IMAGE}:${IMAGE_TAG}|'  ./k8s/prod/k8s-deployment.yaml
                  kubectl apply -f ./k8s/prod/k8s-deployment.yaml
                  kubectl apply -f ./k8s/prod/k8s-service.yaml
                  kubectl rollout status deployment/${K8S_DEPLOYMENT_NAME}
                """
            }
         }
       }
    }
    post {
        success {
            echo "Production deployment completed successfully."
        }
        failure {
            echo "Production deployment failed."
        }
    }
}

